version: "3.9"

services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_DB: app
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
    ports:
      - "5439:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app -d app"]
      interval: 5s
      timeout: 3s
      retries: 20

  tim:
    image: quay.io/keycloak/keycloak:25.0
    command: ["start-dev", "--http-port=8080", "--import-realm"]
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_HOSTNAME_STRICT: "false"
      KC_HTTP_ENABLED: "true"
    ports:
      - "8081:8080"
    volumes:
      # положи сюда dev-realm.json
      - ./tim/import:/opt/keycloak/data/import:ro
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8080/health/ready || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30

  minio:
    image: minio/minio:latest
    command: ["server", "/data", "--console-address", ":9001"]
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio12345
    ports:
      - "9000:9000"
      - "9001:9001"

  minio-mc:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_started
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 minio minio12345;
      mc mb -p local/attachments || true;
      mc anonymous set none local/attachments || true;
      exit 0;
      "

  clamav:
    image: clamav/clamav:latest
    ports:
      - "3310:3310"

  resql:
    build: ./Resql
    container_name: resql
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DB_URL: jdbc:postgresql://postgres:5432/app
      DB_USER: app
      DB_PASS: app
    ports:
      - "8083:8080"

  ruuter:
    build: ./Ruuter
    container_name: ruuter
    depends_on:
      postgres:
        condition: service_healthy
      tim:
        condition: service_healthy
      resql:
        condition: service_started
      attachment-service:
        condition: service_started
    ports:
      - "5000:8080"
    environment:
      TIM_ISSUER: "http://tim:8080/realms/dev"
      # TIM_JWKS_URL: "http://tim:8080/realms/dev/protocol/openid-connect/certs"
    volumes:
      - ./ruuter/conf:/app/conf:ro
      - ./dsl:/DSL:ro

  attachment-service:
    build: ./attachment-service
    depends_on:
      postgres:
        condition: service_healthy
      tim:
        condition: service_healthy
      minio:
        condition: service_started
      clamav:
        condition: service_started
    ports:
      - "8082:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/app
      SPRING_DATASOURCE_USERNAME: app
      SPRING_DATASOURCE_PASSWORD: app

      APP_S3_ENDPOINT: http://minio:9000
      APP_S3_REGION: us-east-1
      APP_S3_BUCKET: attachments
      APP_S3_ACCESS_KEY: minio
      APP_S3_SECRET_KEY: minio12345
      APP_S3_PRESIGN_TTL_SECONDS: "300"

      APP_CLAMAV_HOST: clamav
      APP_CLAMAV_PORT: "3310"

      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://tim:8080/realms/dev
