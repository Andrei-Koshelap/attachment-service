declaration:
  call: declare
  version: 0.1
  description: "Init attachment upload (returns presigned urls)"
  method: post
  accepts: json
  returns: json
  namespace: analytics
  allowlist:
    body:
      - field: filename
        type: string
      - field: contentType
        type: string
      - field: size
        type: integer
      - field: purpose
        type: string

validate:
  switch:
    - condition: "${incoming.body.size} > 104857600"   # 100MB
      next: returnTooLarge
    - condition: "${incoming.body.contentType} not_in ['application/pdf','image/png','image/jpeg']"
      next: returnUnsupported
  next: createMetadata

createMetadata:
  call: http.post
  args:
    url: "${RESQL_URL}/attachments/create"
    body:
      filename: "${incoming.body.filename}"
      declared_content_type: "${incoming.body.contentType}"
      declared_size: "${incoming.body.size}"
      purpose: "${incoming.body.purpose}"
      status: "PENDING_UPLOAD"
  result: meta
  next: initMultipart

initMultipart:
  call: http.post
  args:
    url: "${ATTACHMENT_SERVICE_URL}/api/attachments/init"
    headers:
      Content-Type: "application/json"
      Accept: "application/json"
      Authorization: "${incoming.headers.Authorization}"
    body:
      filename: "${incoming.body.filename}"
      contentType: "${incoming.body.contentType}"
      size: "${incoming.body.size}"
  result: s3
  next: persistUploadId

persistUploadId:
  call: http.post
  args:
    url: "${RESQL_URL}/attachments/set_upload"
    body:
      id: "${meta.response.body.id}"
      uploadId: "${s3.response.body.uploadId}"
  next: assignResponse

assignResponse:
  assign:
    results:
      attachmentId: "${meta.response.body.id}"
      objectKey: "${meta.response.body.object_key}"
      upload:
        uploadId: "${s3.response.body.uploadId}"
        partUrls: "${s3.response.body.partUrls}"
        expiresInSeconds: "${s3.response.body.expiresIn}"
  next: returnInit

returnInit:
  return: '${results}'
  next: end

returnTooLarge:
  status: 413
  assign:
    errorResponse:
      error: "FILE_TOO_LARGE"
  return: "${errorResponse}"
  next: end

returnUnsupported:
  status: 415
  assign:
    errorResponse:
      error: "UNSUPPORTED_MEDIA_TYPE"
  return: "${errorResponse}"
  next: end
