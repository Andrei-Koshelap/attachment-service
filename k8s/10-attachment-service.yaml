apiVersion: apps/v1
kind: Deployment
metadata:
  name: attachment-service
  namespace: attachments-demo
spec:
  replicas: 1
  selector:
    matchLabels: { app: attachment-service }
  template:
    metadata:
      labels: { app: attachment-service }
    spec:
      containers:
        - name: app
          image: attachment-service:dev
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
          env:
            # DB
            - name: SPRING_DATASOURCE_URL
              value: jdbc:postgresql://postgres:5432/app
            - name: SPRING_DATASOURCE_USERNAME
              valueFrom: { secretKeyRef: { name: demo-secrets, key: POSTGRES_USER } }
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom: { secretKeyRef: { name: demo-secrets, key: POSTGRES_PASSWORD } }

            # S3
            - name: APP_S3_ENDPOINT
              value: http://minio:9000
            - name: APP_S3_REGION
              value: us-east-1
            - name: APP_S3_BUCKET
              value: attachments
            - name: APP_S3_ACCESS_KEY
              valueFrom: { secretKeyRef: { name: demo-secrets, key: MINIO_ROOT_USER } }
            - name: APP_S3_SECRET_KEY
              valueFrom: { secretKeyRef: { name: demo-secrets, key: MINIO_ROOT_PASSWORD } }
            - name: APP_S3_PRESIGN_TTL_SECONDS
              value: "300"

            # ClamAV
            - name: APP_CLAMAV_HOST
              value: clamav
            - name: APP_CLAMAV_PORT
              value: "3310"

            # JWT issuer
            - name: SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI
              value: http://tim:8080/realms/dev

            # mail-sender integration (optional, but useful for demo)
            - name: APP_MAIL_SENDER_URL
              value: http://mail-sender:8080

---
apiVersion: v1
kind: Service
metadata:
  name: attachment-service
  namespace: attachments-demo
spec:
  selector: { app: attachment-service }
  ports:
    - name: http
      port: 8080
      targetPort: 8080
