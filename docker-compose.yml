services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_DB: app
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app -d app"]
      interval: 5s
      timeout: 3s
      retries: 20

  tim:
    build: ./TIM
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "8081:8085"
    volumes:
      - ./tim-jwt-keystore.p12:/run/secrets/tim-jwt-keystore.p12:ro
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/app
      SPRING_DATASOURCE_USERNAME: app
      SPRING_DATASOURCE_PASSWORD: app

      # JWT signature config (maps to jwt-integration.signature.*)
      JWT_INTEGRATION_SIGNATURE_KEY_STORE_TYPE: PKCS12
      JWT_INTEGRATION_SIGNATURE_KEY_STORE: file:/run/secrets/tim-jwt-keystore.p12
      JWT_INTEGRATION_SIGNATURE_KEY_STORE_PASSWORD: changeit
      JWT_INTEGRATION_SIGNATURE_KEY_ALIAS: jwt-sign

  minio:
    image: minio/minio:latest
    command: ["server", "/data", "--console-address", ":9001"]
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio12345
    ports:
      - "9000:9000"
      - "9001:9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/ready"]
      interval: 3s
      timeout: 2s
      retries: 40

  minio-mc:
    image: minio/mc:latest
    restart: "no"
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      set -e;
      echo 'Waiting for MinIO...';
      until mc alias set local http://minio:9000 minio minio12345 >/dev/null 2>&1; do
        sleep 2;
      done;
      mc mb -p local/attachments || true;
      mc anonymous set none local/attachments || true;
      echo 'Bucket ready: attachments';
      "

  clamav:
    image: clamav/clamav:latest
    ports:
      - "3310:3310"

  resql:
    build: ./Resql
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./dsl:/DSL:ro
    environment:
      DB_URL: jdbc:postgresql://postgres:5432/app
      DB_USER: app
      DB_PASS: app
      SERVER_PORT: "8080"
    ports:
      - "8083:8080"

  ruuter:
    build: ./Ruuter
    depends_on:
      postgres:
        condition: service_healthy
      resql:
        condition: service_started
      attachment-service:
        condition: service_started
    ports:
      - "5000:8080"
    environment:
      - TIM_URL=http://tim:8085
      - TIM_USERINFO_PATH=/jwt/custom-jwt-userinfo
      - RESQL_URL=http://resql:8080
      - ATTACHMENT_SERVICE_URL=http://attachment-service:8080
    volumes:
      - ./ruuter/conf:/app/conf:ro
      - ./dsl:/DSL:ro

  attachment-service:
    build: ./attachment-service
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_started
      clamav:
        condition: service_started
    ports:
      - "8082:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/app
      SPRING_DATASOURCE_USERNAME: app
      SPRING_DATASOURCE_PASSWORD: app

      APP_S3_ENDPOINT: http://minio:9000
      APP_S3_REGION: us-east-1
      APP_S3_BUCKET: attachments
      APP_S3_ACCESS_KEY: minio
      APP_S3_SECRET_KEY: minio12345
      APP_S3_PRESIGN_TTL_SECONDS: "300"

      APP_CLAMAV_HOST: clamav
      APP_CLAMAV_PORT: "3310"
